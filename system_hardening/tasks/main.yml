---
# tasks file for system_hardening
- name: Upgrade operating system
  ansible.builtin.apt:
    upgrade: dist
  become: true

- name: Update and upgrade system packages
  ansible.builtin.apt:
    upgrade: yes
    update_cache: yes
  become: true

- name: Ensure that UFW is installed
  ansible.builtin.apt:
    name: ufw
    state: present
  become: true

- name: Enable UFW
  community.general.ufw:
    state: enabled
    policy: allow
  become: true

- name: Make a UFW exception for SSH
  community.general.ufw:
    rule: limit
    port: ssh
    proto: tcp
  become: true

- name: Change SSH port in SSHD configuration file
  ansible.builtin.copy:
    src: ssh.socket.d
    dest: /etc/systemd/system/
  become: true

- name: Disable password login in SSHD configuration file
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config.d/50-cloud-init.conf
    regexp: "^PasswordAuthentication yes"
    line: "PasswordAuthentication no"
  become: true

- name: Reload daemon
  ansible.builtin.command: systemctl daemon-reload
  become: true

- name: Restart SSH service
  ansible.builtin.service:
    name: ssh
    state: restarted
  become: true
